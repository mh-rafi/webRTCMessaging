<!DOCTYPE html>
<html ng-app="newJobs" lang="en">
<head>
  <base href="/">
	<meta charset="UTF-8">
	<title>WebRTCMessaging</title>
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">

  <script src="https://code.oovoo.com/webrtc/oovoosdk-2.1.1.min.js"></script>
</head>
<body>
	<nav class="navbar navbar-default">
    <div class="container header_container">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#"><span class="glyphicon glyphicon-th"></span></a>
      </div>

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li><a href="/">Home</a></li>
        </ul>
         <ul class="nav navbar-nav navbar-right">
          <li ng-hide="authenticated"><a href="/login">Login</a></li>
          <li ng-hide="authenticated"><a href="/register">Register</a></li>
          <li ng-show="authenticated"><a href="/user/{{current_user.username}}">{{current_user.username}}</a></li>
          <li ng-show="authenticated"><a href="" class="msg_noti" ng-click="goToMessages()">Messages<span ng-show="msgNotification" class="fa fa-exclamation"></span></a></li>
          <li ng-show="authenticated"><a href="#" ng-click="signOut()">Log out</a></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
  </nav>
<video id="localVideo" style="width:50%; height:auto;" autoplay muted></video>
<div ng-view></div>
<div class="section_loading" ng-show="loading">
  <div class="box loading_box">
    <div class="load_text">{{loadText}}</div>
  </div>
</div>
<script>
  
 var avchatObj = null;
        var conferenceId = "mtconfid";
        var appToken = "MDAxMDAxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADYRzQeJwJ9kIT1W0phkyxfph65BBwLjVSKIQ0dFZTpODdrTSBwB97bp8GCTZyPmRD6CbT64Dh5R2kwRKM8DySov0OvOwMPtqOLD%2B7eobHmqsh3%2BPtpwU%2FDGlGAJOwpOYk%3D";
        var sessionToken = getQSParam("t");
        var participantId = getQSParam("pid");

        if (!sessionToken) {
            //login to get session token
            //for example (get random id)
            console.log('Not session');
            participantId = Math.floor(Math.random() * 9999999999) + 1000000000;

            var redirectUrl = "url to send response with the session token"
            redirectUrl = location.href + "?pid=" + participantId;

            console.log(redirectUrl);
            setTimeout(function() {
                ooVooClient.authorization({
                    token: appToken,
                    isSandbox: true,
                    userId: participantId,
                    callbackUrl: redirectUrl
                });
            }, 3000)
        } else {
            console.log(sessionToken);
            ooVooClient.connect({
                userId: participantId,
                userToken: sessionToken
            }, onClientConnected);
        }

        function onClientConnected(res) {
            //init conference
            avchatObj = ooVooClient.AVChat.init({
                video: true,
                audio: true,
                videoResolution: ooVooClient.VideoResolution["HIGH"],
                videoFrameRate: new Array(5, 15)
            }, onAVChatInit);
            console.log(avchatObj)
        }

        function onAVChatInit(res) {
            if (!res.error) {
                //register to conference events
                avchatObj.onParticipantJoined = onParticipantJoined;
                avchatObj.onParticipantLeft = onParticipantLeft;
                avchatObj.onConferenceStateChanged = onConferenceStateChanged;
                avchatObj.onRemoteVideoStateChanged = onRemoteVideoStateChanged
                avchatObj.join(conferenceId, participantId, "participant name", function (result) { });
            }
        }

        function onParticipantLeft(evt) {
            if (evt.uid) {
                document.getElementById("vid_" + evt.uid).remove();
            }
        }
        function onParticipantJoined(evt) {
            if (evt.stream && evt.uid != null) {
                if (evt.uid == participantId) { //me
                    document.getElementById("localVideo").src = URL.createObjectURL(evt.stream);
                }
                else { //participants
                    var videoElement = document.createElement("video");
                    videoElement.id = "vid_" + evt.uid;
                    videoElement.src = URL.createObjectURL(evt.stream);
                    videoElement.setAttribute("autoplay", true);
                    document.body.appendChild(videoElement);
                }
            }
        }
        function onConferenceStateChanged(evt) {
        }
        function onRemoteVideoStateChanged(evt) {
        }

        function getQSParam(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : results[1].replace(/\+/g, " ");
        }
</script>

  <script src="js/jquery-1.12.0.min.js"></script>
  <script src="js/socket.io-1.4.3.js"></script>
	<script src="https://code.angularjs.org/1.5.0-beta.2/angular.min.js"></script>
  <script src="https://code.angularjs.org/1.5.0-beta.2/angular-route.min.js"></script>
  <script src="https://code.angularjs.org/1.5.0-beta.2/angular-resource.min.js"></script>
	<script src="https://code.angularjs.org/1.5.0-beta.2/angular-cookies.min.js"></script>
  <script src="js/app.js"></script>
  <script src="profile/profile.js"></script>
  <script src="message/message.js"></script>
</body>
</html>